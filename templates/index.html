<!doctype html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Your Friend AI</title>

  <style>
    :root{
      --bg1:#0b1320;
      --bg2:#0e1a2a;
      --card:#0f2238;
      --bubble-bot:#1b2c43;
      --bubble-user:#2e87ff;
      --text:#eaf2ff;
      --muted:#9fb3cc;
      --border:rgba(255,255,255,.08);
      --green:#10c46b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background: radial-gradient(1200px 700px at 30% 20%, #173b5a 0%, transparent 60%),
                  radial-gradient(900px 600px at 70% 80%, #13384b 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
    }

    .wrap{
      width:min(860px, 94vw);
      height:min(760px, 92vh);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:24px;
      box-shadow:0 18px 60px rgba(0,0,0,.45);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    header{
      padding:18px 18px 12px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .title{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .dot{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg,#66d1ff,#2e87ff);
      display:flex;align-items:center;justify-content:center;
      font-size:18px;
      box-shadow:0 10px 25px rgba(46,135,255,.35);
    }
    .title h1{
      margin:0;
      font-size:20px;
      letter-spacing:.2px;
    }
    .title p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted);
    }

    .controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(0,0,0,.12);
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn{
      border:none;
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:8px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      font-size:12px;
      transition:transform .08s ease, background .2s ease;
    }
    .btn:hover{background:rgba(255,255,255,.12)}
    .btn:active{transform:scale(.98)}
    .btn.green{background:rgba(16,196,107,.18)}
    .btn.green:hover{background:rgba(16,196,107,.26)}
    .btn.red{background:rgba(255,72,72,.16)}
    .btn.red:hover{background:rgba(255,72,72,.22)}

    .chat{
      flex:1;
      padding:18px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .bubble{
      max-width:78%;
      padding:12px 14px;
      border-radius:16px;
      line-height:1.35;
      border:1px solid var(--border);
      white-space:pre-wrap;
      word-break:break-word;
      animation:pop .16s ease;
    }
    @keyframes pop{from{transform:scale(.98);opacity:.7}to{transform:scale(1);opacity:1}}
    .bot{
      align-self:flex-start;
      background:rgba(27,44,67,.75);
    }
    .user{
      align-self:flex-end;
      background:rgba(46,135,255,.25);
      border-color:rgba(46,135,255,.35);
    }

    footer{
      padding:14px;
      border-top:1px solid var(--border);
      display:flex;
      gap:10px;
      align-items:center;
      background:rgba(0,0,0,.10);
    }
    .input{
      flex:1;
      background:#0b1625;
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px 14px;
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    .send{
      background:var(--green);
      color:#06210f;
      font-weight:800;
      padding:12px 18px;
      border-radius:16px;
      border:none;
      cursor:pointer;
    }
    .send:disabled{
      opacity:.6;
      cursor:not-allowed;
    }
    .mic{
      width:44px;height:44px;border-radius:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-size:18px;
    }
    .mic.on{
      background:rgba(46,135,255,.25);
      border-color:rgba(46,135,255,.35);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <div class="dot">ðŸ¤–</div>
        <div>
          <h1>Your Friend AI</h1>
          <p>Hashan â€¢ boyfriend mode â€¢ voice</p>
        </div>
      </div>

      <div class="controls">
        <div class="pill" id="voiceStatus">Voice: ready</div>
        <button class="btn green" id="toggleVoice">Voice ON</button>
        <button class="btn red" id="resetBtn">Reset</button>
      </div>
    </header>

    <div class="chat" id="chat"></div>

    <footer>
      <button class="mic" id="micBtn" title="Speak">ðŸŽ¤</button>
      <input class="input" id="msg" placeholder="Type a message..." autocomplete="off" />
      <button class="send" id="sendBtn">Send</button>
    </footer>
  </div>

  <!-- OPTIONAL SFX -->
  <audio id="sfxLaugh" src="/static/sfx/laugh.mp3" preload="auto"></audio>
  <audio id="sfxKiss"  src="/static/sfx/kiss.mp3" preload="auto"></audio>

  <script>
    const chat = document.getElementById("chat");
    const msgInput = document.getElementById("msg");
    const sendBtn = document.getElementById("sendBtn");
    const resetBtn = document.getElementById("resetBtn");
    const toggleVoiceBtn = document.getElementById("toggleVoice");
    const voiceStatus = document.getElementById("voiceStatus");
    const micBtn = document.getElementById("micBtn");

    let voiceEnabled = true;

    function stripEmojisForVoice(text){
      return (text || "")
        .replace(/[\u{1F300}-\u{1FAFF}]/gu, "")
        .replace(/[\u{2600}-\u{27BF}]/gu, "")
        .replace(/\s+/g, " ")
        .trim();
    }

    function addMsg(text, who){
      const div = document.createElement("div");
      div.className = "bubble " + (who === "user" ? "user" : "bot");
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      return div;
    }

    function addLoading(text = "Generating imageâ€¦ â³"){
      const div = document.createElement("div");
      div.className = "bubble bot";
      div.dataset.loading = "1";
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      return div;
    }

    function replaceLoadingWithImage(loadingDiv, src){
      if (!loadingDiv) return;
      loadingDiv.textContent = "";

      const img = document.createElement("img");
      img.src = src;
      img.style.maxWidth = "100%";
      img.style.borderRadius = "12px";
      img.style.marginTop = "5px";

      loadingDiv.appendChild(img);
      chat.scrollTop = chat.scrollHeight;
    }

    function playSfxIfNeeded(text){
      const t = (text || "").toLowerCase();
      if (t.includes("ðŸ˜‚") || t.includes("ðŸ¤£") || t.includes("haha") || t.includes("hehe")){
        document.getElementById("sfxLaugh")?.play().catch(()=>{});
      }
      if (t.includes("ðŸ˜˜") || t.includes("ðŸ’‹") || t.includes("kiss")){
        document.getElementById("sfxKiss")?.play().catch(()=>{});
      }
    }

    function speak(text){
      if (!voiceEnabled) return;
      if (!("speechSynthesis" in window)){
        voiceStatus.textContent = "Voice: not supported";
        return;
      }

      window.speechSynthesis.cancel();

      const clean = stripEmojisForVoice(text);
      if (!clean) return;

      const u = new SpeechSynthesisUtterance(clean);
      u.lang = "en-US";
      u.rate = 1.0;
      u.pitch = 1.05;

      u.onstart = () => voiceStatus.textContent = "Voice: speakingâ€¦";
      u.onend   = () => voiceStatus.textContent = "Voice: ready";
      u.onerror = () => voiceStatus.textContent = "Voice: error (blocked?)";

      window.speechSynthesis.speak(u);
    }

    async function sendMessage(text){
      text = (text || "").trim();
      if (!text) return;

      addMsg(text, "user");
      msgInput.value = "";

      const lower = text.toLowerCase();

      // IMAGE requests
      if (lower.includes("image") || lower.includes("picture") || lower.includes("photo")) {
        const loadingDiv = addLoading("Generating imageâ€¦ â³");

        sendBtn.disabled = true;
        try{
          const res = await fetch("/api/image", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ prompt: text })
          });

          const data = await res.json();

          if (data.ok && data.b64){
            const imgSrc = "data:image/png;base64," + data.b64;
            replaceLoadingWithImage(loadingDiv, imgSrc);
          } else {
            loadingDiv.textContent = "Couldn't generate image ðŸ˜”";
          }
        }catch(e){
          loadingDiv.textContent = "Image generation failed ðŸ˜”";
        }finally{
          sendBtn.disabled = false;
        }
        return;
      }

      // Normal chat
      sendBtn.disabled = true;
      try{
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text })
        });

        if (!res.ok) throw new Error("Bad response");
        const data = await res.json();

        const reply = data.reply || "â€¦";
        addMsg(reply, "bot");

        playSfxIfNeeded(reply);
        speak(reply);

      }catch(e){
        addMsg("Server error. Try again.", "bot");
      }finally{
        sendBtn.disabled = false;
      }
    }

    // Handlers (ONLY once)
    sendBtn.onclick = () => sendMessage(msgInput.value);
    msgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage(msgInput.value);
    });

    resetBtn.onclick = () => {
      chat.innerHTML = "";
      addMsg("Heyy ðŸ¥° Iâ€™m here for youâ€¦ talk to me ðŸ’—", "bot");
      speak("Heyy I'm here for you, talk to me");
    };

    toggleVoiceBtn.onclick = () => {
      voiceEnabled = !voiceEnabled;
      toggleVoiceBtn.textContent = voiceEnabled ? "Voice ON" : "Voice OFF";
      toggleVoiceBtn.classList.toggle("green", voiceEnabled);
      toggleVoiceBtn.classList.toggle("red", !voiceEnabled);
      voiceStatus.textContent = voiceEnabled ? "Voice: ready" : "Voice: off";
      window.speechSynthesis.cancel();
    };

    // Mic (speech to text)
let rec = null;
let isListening = false;
let finalBuffer = "";

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

function setListeningUI(on){
  if (on){
    micBtn.classList.add("on");
    voiceStatus.textContent = "Listeningâ€¦";
  } else {
    micBtn.classList.remove("on");
    voiceStatus.textContent = voiceEnabled ? "Voice: ready" : "Voice: off";
  }
}

function startRec(){
  if (!rec || isListening) return;
  finalBuffer = "";
  msgInput.value = "";
  try { rec.start(); } catch {}
}

function stopRecAndSend(){
  if (!rec || !isListening) return;
  try { rec.stop(); } catch {}
  // send after a tiny delay so last words arrive
  setTimeout(() => {
    const toSend = (finalBuffer || msgInput.value || "").trim();
    if (toSend){
      msgInput.value = "";
      sendMessage(toSend);
    }
  }, 250);
}

if (SpeechRecognition){
  rec = new SpeechRecognition();
  rec.lang = "en-US";
  rec.interimResults = true;
  rec.continuous = true;

  rec.onstart = () => { isListening = true; setListeningUI(true); };
  rec.onend   = () => { isListening = false; setListeningUI(false); };

  rec.onerror = () => { isListening = false; setListeningUI(false); };

  rec.onresult = (e) => {
    let interim = "";
    for (let i = e.resultIndex; i < e.results.length; i++){
      const txt = e.results[i][0].transcript;
      if (e.results[i].isFinal) finalBuffer = (finalBuffer + " " + txt).trim();
      else interim += txt;
    }
    msgInput.value = (finalBuffer + " " + interim).trim();
  };

  // âœ… Press & hold (mouse)
  micBtn.addEventListener("mousedown", (e) => { e.preventDefault(); startRec(); });
  window.addEventListener("mouseup", () => stopRecAndSend());

  // âœ… Press & hold (touch/mobile)
  micBtn.addEventListener("touchstart", (e) => { e.preventDefault(); startRec(); }, {passive:false});
  window.addEventListener("touchend", () => stopRecAndSend());

} else {
  micBtn.disabled = true;
  micBtn.title = "Mic not supported in this browser";
}





    // Initial message
    addMsg("Heyy ðŸ¥° Iâ€™m here for youâ€¦ talk to me ðŸ’—", "bot");
    speak("Heyy I'm here for you, talk to me");
  </script>
</body>
</html>
